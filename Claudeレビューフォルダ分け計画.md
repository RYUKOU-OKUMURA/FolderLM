# フォルダ分け計画レビュー

## 概要
NotebookLMのノート一覧にフォルダベースの並べ替え/グループ化機能を追加する計画のレビュー。

---

## 良い点 ✓

### 1. 明確で詳細な要件定義
- 「NotebookLMのデータに干渉しない」という非侵襲的アプローチが明示されている
- ANDロジック（NotebookLMフィルタとの併用）が正しく認識されている
- DOM操作のみで実装する方針が適切

### 2. 適切なスコープ設定
- 範囲内/範囲外が明確に区分されている
- ドラッグ&ドロップやバックグラウンド処理など複雑な機能を意図的に除外
- MVPとして適切なスコープ

### 3. 既存アーキテクチャへの適合
- 適切なファイル/エントリーポイントが特定されている（filterManager, noteDetector, domRecoveryManager等）
- 既存の`storageManager.getFolders()`の順序を利用する設計
- domRecoveryManagerへの統合も考慮

### 4. データモデル変更が最小限
- `viewMode: 'filter' | 'sort' | 'group'`という単純なフラグのみ
- 既存のフォルダ/割り当てデータを再利用
- ストレージへの影響が小さい

### 5. テスト計画の存在
- 具体的な検証項目が列挙されている
- ANDロジック、パフォーマンス、アクセシビリティをカバー

### 6. リスク認識
- 仮想化/再レンダリングへの懸念が記載
- IDなしノートの処理を認識
- CSS orderとDOM並べ替えのトレードオフに言及

---

## 改善点 ✗

### 1. viewModeの3つの値の違いが不明確
**現状:** `'filter' | 'sort' | 'group'`と定義されているが、各モードの具体的な挙動が曖昧

**提案:**
```
- filter: 現在の動作（非表示）、変更なし
- sort:   ノートをフォルダ順に並べ替え、ヘッダーなし
- group:  ノートをフォルダ順に並べ替え＋グループヘッダー表示
```
明確なモード定義を計画に追加すべき

### 2. グループヘッダーの具体的な実装方針がない
**現状:** 「軽量なグループヘッダーを作成」としか記載がない

**提案:**
- ヘッダーのHTML構造を明示（例: `<div class="folderlm-group-header" role="separator">`）
- ヘッダーをクリック不可にする方法（`pointer-events: none`等）
- ヘッダーの挿入位置（リストアイテムの直前 vs 親コンテナに別要素）

### 3. パフォーマンスへの配慮が不足
**現状:** 「多数のノートがある場合の負荷テスト」のみ

**提案:**
- 並べ替え処理をRAFでバッチ化する明示的な方針
- 差分検知による最小限の再並べ替え（全体再構築を避ける）
- ノート数N件に対するO(N log N)ソートの許容範囲

### 4. CSS orderとDOM並べ替えのトレードオフ分析が不十分
**現状:** 「CSS orderの方が安全だがヘッダー挿入には向かない」という認識のみ

**提案:**
明確な方針を決定すべき:
- **sortモード:** CSS `order`プロパティを使用（安全、復元が容易）
- **groupモード:** DOM並べ替え＋ヘッダー挿入が必須

復元方法:
- CSS order使用時: `order: ''`にリセット
- DOM並べ替え時: 元のインデックスをdata属性に保存

### 5. 未解決の質問に対する推奨事項がない
**現状:** 3つの質問が未回答のまま

**提案:**
- グループヘッダーは「すべて」選択時のみ表示 → **推奨: Yes**（特定フォルダ選択時は不要）
- viewModeをリロード後も維持すべきか → **推奨: Yes**（settings に保存）
- 「元に戻す」ボタン → **推奨: 「すべて」選択で自動的にリセットで十分**

### 6. 既存モジュールへの具体的な変更箇所が不明確
**現状:** ファイル名のみで具体的な関数/メソッドの変更が示されていない

**提案:**
```
filterManager.js:
  + applyViewMode(mode: 'filter'|'sort'|'group')
  + _sortByFolder()
  + _groupByFolder()
  - 修正: selectFolder()にviewMode考慮を追加

domRecoveryManager.js:
  - 修正: _checkRecoveryNeeded()でグループヘッダーも検知

noteDetector.js:
  - 変更なし（既存APIで十分）
```

### 7. 並べ替え時の安定性保証が不明
**現状:** 「NotebookLM本来の順序を維持」とあるが方法が不明

**提案:**
- スキャン時にノートカードのDOM順序をインデックスとして記録
- ソート時に同一フォルダ内ではこのインデックスで安定ソート
- `Array.prototype.sort`の安定性に依存せず明示的に処理

### 8. UIフックの詳細設計がない
**現状:** 「小さなトグル」という曖昧な記述

**提案:**
- ドロップダウンヘッダーに並列してモード切替ボタン配置
- または各フォルダアイテムの右側にソート/グループアイコン
- モード状態をfolderButtonのインジケーターに反映

---

## リスク追加提案

### 追加すべきリスク
1. **NotebookLMの構造変更:** aria-*属性やCSSクラスが変更された場合、セレクタが壊れる
2. **A11y影響:** グループヘッダー追加でスクリーンリーダーの読み上げ順序が変わる可能性
3. **フォルダ削除時:** グループ化中にフォルダが削除された場合の処理

---

## 決定事項（ユーザー確認済み）

| 質問 | 決定 |
|------|------|
| グループヘッダー表示 | 「すべて」選択時のみ |
| viewModeの永続化 | `storageManager.settings`に保存 |
| MVPの優先順位 | sortモード優先 |

---

## 推奨される次のステップ

1. ~~未解決の質問を決定する~~ ✓ 決定済み
2. **viewModeの3モードを明確に定義する**
   - `filter`: 現在の動作（非該当ノートを非表示）
   - `sort`: フォルダ順に並べ替え、ヘッダーなし
   - `group`: フォルダ順に並べ替え + ヘッダー表示
3. **Phase 1: sortモード実装** - CSS `order`プロパティ使用
4. **Phase 2: groupモード実装** - DOM並べ替え + ヘッダー挿入
5. **パフォーマンス要件を数値化する**（例: 100ノート以下で16ms以内）

---

## 総評

計画書は全体的に良好で、既存アーキテクチャへの理解が正確です。主な改善点は**実装詳細の具体化**（CSS order vs DOM並べ替え、グループヘッダーのHTML構造、変更対象のメソッド名）です。

sortモードをMVPとして実装し、グループヘッダーなしで安全にリリースできます。この段階でパフォーマンスと復帰処理を検証した後、groupモードを追加する段階的アプローチが推奨されます。
