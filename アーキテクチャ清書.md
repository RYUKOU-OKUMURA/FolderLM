# FolderLM アーキテクチャ（清書）

## 1. 目的と前提

- 本書は `要件定義書_清書.md` に基づく実装アーキテクチャの整理
- NotebookLM の DOM 表示のみを対象とする
- 外部通信・ノート本文/メタ情報の保存は行わない

---

## 2. システム構成

### 2.1 構成要素
- **Content Script**: DOM 解析・UI 挿入・イベント処理
- **Storage**: `chrome.storage.sync` への永続化
- **Background**: 将来拡張用（MVP では省略可）

### 2.2 データ保持
- 保存対象は「フォルダ情報」と「ノートID割り当て」のみ

---

## 3. ディレクトリ構成（案）

```
folder-lm/
├── manifest.json
├── src/
│   ├── content/
│   │   ├── index.js
│   │   ├── content.css
│   │   ├── core/
│   │   │   ├── domObserver.js
│   │   │   ├── noteDetector.js
│   │   │   └── filterManager.js
│   │   ├── ui/
│   │   │   ├── folderButton.js
│   │   │   ├── folderDropdown.js
│   │   │   ├── noteAssignButton.js
│   │   │   └── folderSelectPopup.js
│   │   └── utils/
│   │       ├── selectors.js
│   │       ├── idParser.js
│   │       └── debounce.js
│   ├── storage/
│   │   └── storageManager.js
│   └── background/
│       └── background.js
└── assets/
    └── icons/
```

---

## 4. モジュール責務

### 4.1 Content Script
- `index.js`: 初期化、依存関係の組み立て、イベント配線
- `domObserver.js`: `MutationObserver` で DOM 再描画を監視
- `noteDetector.js`: ノートカード検出・ノートID抽出
- `filterManager.js`: フィルタ状態管理と表示制御

### 4.2 UI
- `folderButton.js`: ヘッダーに追加するフォルダボタン
- `folderDropdown.js`: フォルダ一覧/作成 UI
- `noteAssignButton.js`: ノートカードの割り当てボタン
- `folderSelectPopup.js`: フォルダ選択ポップアップ

### 4.3 Storage
- `storageManager.js`: `chrome.storage.sync` 読み書きとバリデーション

---

## 5. データモデル

```json
{
  "folders": [
    { "id": "folder_1", "name": "仕事用", "order": 0 }
  ],
  "noteAssignments": {
    "note_uuid_1": "folder_1"
  }
}
```

**ルール**
- 「未分類」は常に存在（削除・名称変更不可）
- フォルダ名は空不可、最大 30 文字
- 重複名は禁止（前後空白除去・大文字小文字無視）

---

## 6. ノートID取得戦略

### 6.1 第一候補（安定ID）
- ノートカード要素の `aria-labelledby` / `aria-describedby` に含まれる
  `project-<UUID>-title` 形式の UUID を抽出

### 6.2 フォールバック
- ノートを開いた URL の `/notebook/<UUID>` を使用

### 6.3 失敗時の挙動
- 取得できない場合は UI 非表示 + 通知で機能停止

---

## 7. UI 差し込み方針

- 追加先: `div.project-actions-container` 内のボタン群周辺
- 既存 UI に合わせた高さ・余白
- セレクタは安定クラス/ARIAのみ使用
- `_ngcontent-*` や動的IDは使用しない

---

## 8. フロー設計

### 8.1 初期化
1. DOM 読み込み後に `storageManager.load()`
2. フォルダ/割り当てデータ取得
3. UI 挿入と既存ノートへの反映

### 8.2 フォルダ作成
1. 入力 → バリデーション
2. `folders` 更新 → 保存
3. UI 更新

### 8.3 ノート割り当て
1. ノートID抽出
2. フォルダ選択 → `noteAssignments` 更新
3. 保存 → ノート表示更新

### 8.4 フィルタリング
1. フォルダ選択
2. NotebookLM 標準フィルタと AND 条件で適用
3. 対象ノートのみ表示

---

## 9. エラーハンドリング

| ケース | 対応 |
|---|---|
| DOM要素が見つからない | リトライ（最大3回）→失敗時停止と通知 |
| ノートID取得失敗 | フォールバック → 失敗時UI停止 |
| ストレージ容量超過 | ユーザー通知、古いデータ削除の提案 |
| 破損データ | 安全に初期化（未分類のみ） |

---

## 10. パフォーマンス

- DOM 操作はバッチ化し `requestAnimationFrame` で反映
- ストレージ書き込みはデバウンス（300ms）
- 一覧切替後 200ms 以内に状態反映を目標
- 最大 1,000 ノート / 200 フォルダを目標

---

## 11. セキュリティ/プライバシー

- ノート本文/タイトル/メタ情報は保存しない
- 外部送信なし
- `innerHTML` 不使用、`textContent`/DOM API 使用

---

## 12. 検証項目（最小）

- ノートIDがリネームや並び替えで変わらない
- DOM 再描画後も UI が復帰する
- フォルダ作成/削除/割り当てが再起動後も維持
- NotebookLM 標準フィルタと併用できる

---

## 13. 未決定事項

- DOM 調査結果に基づくセレクタの最終確定
- Background script の採用有無（MVPでは省略可能）
- 同期容量に応じたフォルダ/ノート上限の確定

---

## 14. DOM 調査メモ（確定事項）

### 14.1 ID 取得の実測結果
- ノート一覧で `aria-labelledby` に含まれる `project-<UUID>-title` から
  UUID を抽出できることを確認
- 検証結果: `nodes: 77 / unique IDs: 77`（ノート数と1:1）

### 14.2 利用可能な安定要素
- ノートカード: `aria-labelledby` / `aria-describedby` に UUID が含まれる
- ノート URL: `/notebook/<UUID>` が存在
- UI 差し込み候補: `div.project-actions-container` 付近

### 14.3 避けるべき要素
- `_ngcontent-*` のような自動生成属性
- `mat-button-toggle-5` などの自動採番 ID
