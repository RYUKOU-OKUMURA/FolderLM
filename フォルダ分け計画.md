# フォルダ分け計画

## 計画
NotebookLM の内部データには干渉せず、FolderLM の割り当て情報と DOM 復帰（Recovery）に連携しながら、ノート一覧へフォルダ順の並べ替え/グループ化表示を追加する。NotebookLM 標準フィルタとの AND 条件を維持し、DOM/CSS のみで軽量かつ非侵襲に動作させる。

## 要件
- NotebookLM 標準フィルタとの AND 条件を維持する。
- DOM 表示のみを操作し、NotebookLM 内部データへは干渉しない。
- クリックターゲットやリストセマンティクスを壊さず、アクセシビリティに配慮する。
- ノート ID は `aria-labelledby="project-<UUID>-title"` から抽出する。
- フォルダ割り当ては **1ノート=1フォルダ**（`noteAssignments: { [noteId]: folderId }`）を前提とする。

## 決定事項
- グループヘッダー表示は「すべて」選択時のみ行う。
- `viewMode` は `storageManager.settings` に保存し、リロード後も維持する。
- MVP は **sort モード**を優先する。

## 表示モード定義
- `filter`: 現行と同様に非該当ノートを非表示（並べ替えなし）。
- `sort`: フォルダ順に並べ替え、ヘッダーなし。
  - 可能なら CSS `order` を使用し、不可なら DOM 並べ替えにフォールバック。
- `group`: フォルダ順に並べ替え + グループヘッダー表示。
  - 「すべて」選択時のみ有効、DOM 並べ替え + ヘッダー挿入。

## スコープ
- **範囲内**: 並べ替え/グループ化ロジック、グループヘッダー、順序変更、復帰処理への統合、表示モード用 UI。
- **範囲外**: NotebookLM 内部順序の永続変更、ドラッグ&ドロップ、バックグラウンド処理、データモデルの拡張。

## データモデル / 挙動
- グループ順序は `storageManager.getFolders()` の順（「未分類」を含む）を使用。
- 未割り当てノートは「未分類」に分類。
- 同一フォルダ内の順序は NotebookLM の元の DOM 順序を尊重する。
- 安定ソートのため、スキャン時に元のインデックスを記録（`dataset` または `WeakMap`）。
  - 再レンダリング/再スキャン時には必ず再初期化し、古い順序を引きずらない。

## 実装ポイント（ファイル/関数）
- `src/content/core/filterManager.js`
  - `applyViewMode(mode)` を追加
  - `_sortByFolder()` / `_groupByFolder()` を追加
  - `selectFolder()` に `viewMode` 適用を統合
- `src/content/core/domRecoveryManager.js`
  - `_checkRecoveryNeeded()` でグループヘッダー/並べ替え状態も検知
- `src/content/core/noteDetector.js`
  - 変更なし（既存 API で十分）
- `src/content/utils/selectors.js`
  - グループヘッダー等のセレクタを追加
- `src/content/content.css`
  - グループヘッダーのスタイル/クリック不可設定

## フェーズ別タスク
### Phase 0 — 調査 ✅ 完了 (2025-12-20)
- [x] `NOTE_SELECTORS.LIST_CONTAINER` の `display` が `flex/grid` か実測し、`order` 使用可否を決める。
- [x] スクロール時の DOM 差し替えを観測し、仮想化の有無と頻度を把握する。
- [x] `aria-labelledby` 由来の noteId 抽出が安定するか確認する。
- [x] ヘッダー挿入方式（DOM 挿入 vs `::before`）の A11y 影響を比較する。
- [x] DevTools で `LIST_CONTAINER` の computed style を記録する（`display`/`gap`/`flex-direction`）。
- [x] 50〜100 ノートでスクロール時の DOM 数変化をログ化する。
- [x] `MutationObserver` でノートカードの追加/削除の発生頻度をメモする。
- [x] ノートカードの親タグ（`ul`/`div` 等）と子タグの種類を控える。

**実装ファイル**:
- `src/content/utils/phase0Investigation.js` - 調査スクリプト
- `src/content/utils/selectors.js` - グループヘッダー/並べ替え用セレクタ追加
- `docs/phase0-investigation-report.md` - 調査報告書

### Phase 1 — 設定/状態 ✅ 完了 (2025-12-20)
- [x] `viewMode` の初期値と復元タイミングを定義する。
- [x] `storageManager.settings.viewMode` の保存/復元を実装する。
- [x] `filterManager` の状態に `viewMode` を統合する。
- [x] 元の DOM 順序インデックスの保存/再初期化ルールを実装する。
- [x] `filterManager` に `applyViewMode(mode)` を追加する。
- [x] `filterManager.selectFolder()` に `viewMode` 適用の呼び出しを追加する。
- [x] `domRecoveryManager` から `applyViewMode` を再呼び出しできる導線を作る。
- [x] `settings` からの復元は `load` 完了後に適用する方針を明文化する。

**実装ファイル**:
- `src/storage/storageManager.js` - viewMode の保存/復元、バリデーション
- `src/content/core/filterManager.js` - viewMode 状態管理、applyViewMode、DOM順序インデックス管理
- `src/content/core/domRecoveryManager.js` - viewMode 復帰チェックコールバック
- `src/content/index.js` - viewMode 初期化・復元の統合

**設計方針**:
- `viewMode` のデフォルト値は `'filter'`（現行動作と同等）
- `storageManager.load()` 完了後に `filterManager.initialize({ viewMode })` で復元
- `filterManager.setViewMode(mode)` で変更時に `storageManager.setViewMode(mode)` を呼び出し自動保存
- `domRecoveryManager.onRecovery()` 内で `filterManager.applyViewMode()` を再呼び出し
- 元の DOM 順序インデックスは `data-folderlm-original-index` 属性で保持し、再スキャン時に再初期化

### Phase 2 — sort (MVP)
- [ ] NotebookLM フィルタ通過後の可視ノートのみを対象にする。
- [ ] フォルダ順 + 元インデックスで安定並べ替えを計算する。
- [ ] CSS `order` を適用する（`flex/grid` の場合）。
- [ ] `order` が使えない場合は DOM 並べ替えにフォールバックする。
- [ ] モード解除時に `order` リセット/DOM 復元を保証する。
- [ ] `filterManager._sortByFolder()` を追加し、`NOTE_SELECTORS.LIST_CONTAINER` 配下で対象ノートを収集する。
- [ ] `noteDetector` のスキャン結果から noteId -> DOM を引く経路を整理する。
- [ ] フォルダ順と元インデックスで `order` 値を割り当てる方針を決める。
- [ ] フォールバック用の DOM 並べ替えヘルパを用意する。

### Phase 3 — group
- [ ] 「すべて」選択時のみヘッダーを挿入する。
- [ ] DOM 並べ替えでフォルダブロックを構成する。
- [ ] ヘッダーを非操作・非フォーカスにする。
- [ ] ヘッダーのタグ/role を確定し、リストセマンティクスを壊さない実装にする。
- [ ] 切替時にヘッダー削除と順序復元を担保する。

### Phase 4 — Recovery
- [ ] `domRecoveryManager` に順序/ヘッダーのズレ検知を追加する。
- [ ] DOM 変化や仮想化後に並べ替え/ヘッダーを再適用する。
- [ ] グループ維持が困難な場合に `sort` へフォールバックする。
- [ ] NotebookLM 側のソート変更時に再適用するトリガーを整備する。

### Phase 5 — UI/Styling
- [ ] `filter/sort/group` 切替 UI をドロップダウン付近に追加する。
- [ ] 現在モードが分かるインジケーターを表示する。
- [ ] ヘッダーを控えめにスタイルしクリック不可にする。
- [ ] クリーンアップ用のクラス/data 属性を統一する。

### Phase 6 — Validation
- [ ] 「すべて / マイ / 共有」タブで FolderLM フィルタとの AND ロジックを検証する。
- [ ] `filter` / `sort` / `group` 切替の安定性と復元を確認する。
- [ ] NotebookLM のソート変更後にフォルダ並び替えが再適用されることを確認する。
- [ ] 多数ノート/連続切替のパフォーマンスを確認する。
- [ ] キーボード操作/スクリーンリーダーの退行を確認する。
- [ ] 100 ノート程度で 16ms 以内の目標を簡易計測する。

## パフォーマンス方針
- 更新は `requestAnimationFrame` でバッチ化し、連続変化を統合する。
- 差分検知で最小限の再並べ替え（全再構築を避ける）。
- 100 ノート程度を想定し、16ms を目標にする。

## リスクとエッジケース
- NotebookLM 側の DOM 構造変更（aria 属性/クラス変化）でセレクタが破綻する。
- 仮想化によりヘッダー/並び替えが消える可能性がある。
- CSS `order` が効かないレイアウトの場合、DOM 並べ替えで競合が起きる。
- グループヘッダー挿入でリストセマンティクス/A11y が崩れる可能性がある。
- フォルダ削除時、割り当てが「未分類」へ移動する前提で UI も同期する必要がある。
