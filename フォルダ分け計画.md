# フォルダ分け計画

## 計画
NotebookLM の内部データには干渉せず、FolderLM の割り当て情報と DOM 復帰（Recovery）に連携しながら、ノート一覧へフォルダ順の並べ替え/グループ化表示を追加する。NotebookLM 標準フィルタとの AND 条件を維持し、DOM/CSS のみで軽量かつ非侵襲に動作させる。

## 要件
- NotebookLM 標準フィルタとの AND 条件を維持する。
- DOM 表示のみを操作し、NotebookLM 内部データへは干渉しない。
- クリックターゲットやリストセマンティクスを壊さず、アクセシビリティに配慮する。
- ノート ID は `aria-labelledby="project-<UUID>-title"` から抽出する。
- フォルダ割り当ては **1ノート=1フォルダ**（`noteAssignments: { [noteId]: folderId }`）を前提とする。

## 決定事項
- グループヘッダー表示は「すべて」選択時のみ行う。
- `viewMode` は `storageManager.settings` に保存し、リロード後も維持する。
- MVP は **sort モード**を優先する。

## 表示モード定義
- `filter`: 現行と同様に非該当ノートを非表示（並べ替えなし）。
- `sort`: フォルダ順に並べ替え、ヘッダーなし。
  - 可能なら CSS `order` を使用し、不可なら DOM 並べ替えにフォールバック。
- `group`: フォルダ順に並べ替え + グループヘッダー表示。
  - 「すべて」選択時のみ有効、DOM 並べ替え + ヘッダー挿入。

## スコープ
- **範囲内**: 並べ替え/グループ化ロジック、グループヘッダー、順序変更、復帰処理への統合、表示モード用 UI。
- **範囲外**: NotebookLM 内部順序の永続変更、ドラッグ&ドロップ、バックグラウンド処理、データモデルの拡張。

## データモデル / 挙動
- グループ順序は `storageManager.getFolders()` の順（「未分類」を含む）を使用。
- 未割り当てノートは「未分類」に分類。
- 同一フォルダ内の順序は NotebookLM の元の DOM 順序を尊重する。
- 安定ソートのため、スキャン時に元のインデックスを記録（`dataset` または `WeakMap`）。
  - 再レンダリング/再スキャン時には必ず再初期化し、古い順序を引きずらない。

## 実装ポイント（ファイル/関数）
- `src/content/core/filterManager.js`
  - `applyViewMode(mode)` を追加
  - `_sortByFolder()` / `_groupByFolder()` を追加
  - `selectFolder()` に `viewMode` 適用を統合
- `src/content/core/domRecoveryManager.js`
  - `_checkRecoveryNeeded()` でグループヘッダー/並べ替え状態も検知
- `src/content/core/noteDetector.js`
  - 変更なし（既存 API で十分）
- `src/content/utils/selectors.js`
  - グループヘッダー等のセレクタを追加
- `src/content/content.css`
  - グループヘッダーのスタイル/クリック不可設定

## アクションアイテム
- [ ] **事前調査**
  - `NOTE_SELECTORS.LIST_CONTAINER` が `flex/grid` か実測する（`order` 使用可否の判断）。
  - ノート一覧の仮想化有無を確認する（スクロール時の DOM 差し替え）。
- [ ] **並べ替え/グループ化アルゴリズム**
  - 可視ノートのみを対象にし、NotebookLM フィルタの非表示状態を維持する。
  - フォルダ順 + 元のインデックスで安定ソートする。
  - `sort`: CSS `order` 優先、不可なら DOM 並べ替え。
  - `group`: DOM 並べ替え + ヘッダー挿入（「すべて」選択時のみ）。
- [ ] **ヘッダー設計**
  - 例: `<div class="folderlm-group-header" role="separator" aria-hidden="true">`。
  - クリック不可/フォーカス不可（`pointer-events: none` / `tabindex="-1"`）。
  - リストセマンティクス維持のため、必要ならノートと同じ要素タグを使用する。
- [ ] **クリーンアップ/復元**
  - CSS `order` 使用時は `order: ''` でリセット。
  - DOM 並べ替え時は元のインデックス順で復元し、ヘッダーを削除。
- [ ] **復帰処理の強化**
  - `domRecoveryManager` で DOM 変更/仮想化検知後に再適用。
  - グループ化が維持できない場合は `sort` へのフォールバックを検討。
- [ ] **UI**
  - フォルダドロップダウン付近に `filter/sort/group` 切替 UI を追加。
  - 有効なモードが明確に分かるインジケーターを表示する。
- [ ] **永続化**
  - `storageManager.settings.viewMode` に保存して復元する。

## パフォーマンス方針
- 更新は `requestAnimationFrame` でバッチ化し、連続変化を統合する。
- 差分検知で最小限の再並べ替え（全再構築を避ける）。
- 100 ノート程度を想定し、16ms を目標にする。

## テストと検証
- 「すべて / マイ / 共有」タブで FolderLM フィルタとの併用確認。
- NotebookLM のソート変更後にフォルダ並び替えが再適用されること。
- `filter` / `sort` / `group` 切替の安定性と復元。
- 多数ノートでのパフォーマンス、スクロール時の仮想化影響。
- キーボード操作/スクリーンリーダーの退行がないこと。

## リスクとエッジケース
- NotebookLM 側の DOM 構造変更（aria 属性/クラス変化）でセレクタが破綻する。
- 仮想化によりヘッダー/並び替えが消える可能性がある。
- CSS `order` が効かないレイアウトの場合、DOM 並べ替えで競合が起きる。
- グループヘッダー挿入でリストセマンティクス/A11y が崩れる可能性がある。
- フォルダ削除時、割り当てが「未分類」へ移動する前提で UI も同期する必要がある。

## 未解決 / 調査
- `LIST_CONTAINER` のレイアウト種別（`flex/grid` か `block` か）。
- 仮想化の有無と再適用の頻度（Mutation/scroll 監視の設計）。
- グループヘッダーは DOM 挿入と `::before` のどちらが安全か。
