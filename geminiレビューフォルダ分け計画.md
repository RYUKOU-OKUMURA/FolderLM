# FolderLM フォルダ分け計画 レビュー

「フォルダ分け計画.md」の内容をレビューしました。全体として、NotebookLMの既存機能を尊重しつつ、非侵襲的に機能拡張を行うための非常に論理的で詳細な計画です。

## 良い点

1. **非侵襲的なアプローチの徹底**
   - NotebookLMの内部データや永続的な順序を書き換えず、DOM/CSSレイアウトのみで解決しようとする姿勢が、サービスのアップデートに対する堅牢性を高めています。
2. **既存アーキテクチャとの整合性**
   - `domRecoveryManager`（再レンダリング対策）や `noteDetector`（ノート検知）との連携が組み込まれており、既存のFolderLMの仕組みを最大限に活用できています。
3. **表示モードの柔軟性**
   - 単なるフィルタリングだけでなく、「並べ替え（Sort）」や「グループ化（Group）」という複数の視覚的オプションを検討している点が、ユーザーの利便性を大きく向上させます。
4. **リスク管理の先回り**
   - 「リストの仮想化（Virtualization）」や「イベントリスナーへの干渉」といった、Webアプリケーションの拡張において最も致命的になり得る技術的リスクが正しく識別されています。

## 改善・検討が必要な点

1. **「リストの仮想化」への具体的な対策**
   - **懸念**: NotebookLMが膨大なノートを扱うためにリストを仮想化（画面外のDOMを削除）している場合、単純なDOMの並べ替えやヘッダーの挿入はスクロール時に即座に破棄されます。
   - **改善案**: 仮想化が確認された場合、スクロールイベントやコンテナのMutationを監視し、新しい要素が表示されるたびに即座に `order` やヘッダーを再適用する「常時適用ロジック」を `domRecoveryManager` に強化して実装する必要があります。

2. **CSS `order` の副作用とレイアウト崩れ**
   - **懸念**: CSSの `order` プロパティは、親要素が `display: flex` または `grid` である必要があります。
   - **改善案**: `LIST_CONTAINER` の元のスタイルを壊さないか確認が必要です。もし `block` 配置であれば、DOM要素自体の入れ替え（`appendChild` による並べ替え）が必要になりますが、これはフレームワーク（React等）の再レンダリングと激しく競合するリスクがあります。

3. **NotebookLM自体のソート機能との競合**
   - **懸念**: NotebookLM側が「更新日順」「名前順」などのソート機能を提供している場合、FolderLMのグループ化とどちらを優先するか、あるいはどう組み合わせるかの定義が必要です。
   - **改善案**: 「グループ内ではNotebookLMの元の順序を維持する」という方針は良いですが、NotebookLM側でソートが変わったことを検知して再グループ化するトリガーが必要です。

4. **グループヘッダーのDOM構造**
   - **懸念**: リストアイテム（ノートカード）が特定のタグ（例: `<li>`）を期待している場合、その間にヘッダー（例: `<div>`）を挿入すると、HTMLのセマンティクスが壊れ、CSSセレクタ（`:first-child` 等）やアクセシビリティに影響が出る可能性があります。
   - **改善案**: ヘッダーをリストアイテムと同じタグにするか、あるいはCSSの擬似要素（`::before`）を活用して、特定のノート（各グループの先頭ノート）の上にヘッダーを浮き上がらせる手法も検討の価値があります。

5. **状態保持のユーザー体験**
   - **改善案**: 「未解決の質問」にあるリロード後の維持については、利便性を考えると `storageManager.settings` に保存して維持すべきです。ただし、意図せず並べ替えられたままだとユーザーが混乱するため、UI上に「並べ替え中」であることが明確にわかるインジケーターが必要です。

## 総評

計画は非常に完成度が高く、このまま実装フェーズに進めるレベルです。特に**「リストの仮想化」への耐性**をどう担保するかが、実装上の最大の難所になると思われます。

実装を開始する前に、まず実際のNotebookLMでノートを大量に作成（またはスクロール監視）し、DOMが動的に差し替わっているか（仮想化の有無）を確認するプロトタイプ調査をアクションアイテムの最初に入れることをお勧めします。
